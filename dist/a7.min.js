var a7=function(){"use strict";return{init:function(a,b,c){var d,e,f;a7.Model.set("console",a.console||{enabled:!1}),a7.Model.set("useTokens",a.useTokens||!0),a7.Model.set("renderer",a.renderer||"mustache"),a7.Model.set("running",!1),d=new Promise(function(a,b){a7.Model.get("console.enabled")?a7.Console.init(a,b):a()}),d.then(function(){a7.Log.trace("a7 - log init"),a7.Log.init(a)}).then(function(){a7.Log.trace("a7 - security init"),a7.Security.init(a)}).then(function(){e=new Promise(function(b,c){a7.Log.trace("a7 - layout init"),a7.Layout.init(a,b,c)}),e.then(function(){f=new Promise(function(a,b){a7.Log.trace("a7 - isSecured"),a7.Security.isSecure(a,b)}),f.then(function(a){a7.Log.info("Init complete. Authenticated: "+a),b()}),f.catch(function(a){a7.Log.error(a),c()})})}),d.catch(function(a){a7.Log.error(a)})},deinit:function(){a7.Model.destroy("user"),a7.Model.destroy("token"),a7.Model.destroy("X-Token"),a7.Model.set("running",!1),sessionStorage.removeItem("user"),sessionStorage.removeItem("token")}}}();a7.Console=function(){"use strict";var a,b="Console Window",c="50%",d=!1,e=function(b,c,d,e){var f=document.createElement("div");f.setAttribute("class","a7-console-row-"+d),void 0!==e&&(f.innerHTML=e+": ",f.setAttribute("class",f.getAttribute("class")+" a7-console-row-"+e)),f.innerHTML+=+(c.getHours()<10?"0"+c.getHours():c.getHours())+":"+(c.getMinutes()<10?"0"+c.getMinutes():c.getMinutes())+": "+b,a.appendChild(f)};return{init:function(f,g){var h=a7.Model.get("console"),i=void 0===h.top?0:h.top,j=void 0===h.right?0:h.right;if(h.enabled){d=!0,a=document.createElement("div"),a.setAttribute("id","consoleDiv"),a.setAttribute("class","a7-console"),document.body.append(a);var k,l=new gadgetui.display.FloatingPane(a,{width:c,title:b,opacity:.7,position:"absolute",right:j,top:i});if(l.selector.setAttribute("right",0),window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void a.innerHTML("Your browser doesn't support WebSockets.");k=new WebSocket(h.wsServer),k.onopen=function(){},k.onerror=function(a){var b="Can't connect to the console socket server.";h.enabled?e(b,new Date,"local"):a7.Log.error(b)},k.onmessage=function(a){var b,c;try{b=JSON.parse(a.data)}catch(b){return void a7.Log.error("This doesn't look like valid JSON: ",a.data)}if("history"===b.type)for(c=0;c<b.data.length;c++)e(b.data[c].text,new Date(b.data[c].time),"websocket");else"message"===b.type?e(b.data.text,new Date(b.data.time),"websocket"):a7.Log.error("This doesn't look like valid JSON: ",b)},window.addEventListener("close",function(a){k.close()}),a7.Console.addMessage=e,a7.Log.info("Console initializing..."),f()}else g("Console init should not be called when console option is set to false.")}}}(),a7.Events=function(){"use strict";var a={},b=a.hasOwnProperty;return{subscribe:function(c,d){b.call(a,c)||(a[c]=[]);var e=a[c].push(d)-1;return{remove:function(){delete a[c][e]}}},publish:function(c,d){b.call(a,c)&&a[c].forEach(function(a){a(d||{})})}}}(),a7.Layout=function(){"use strict";var a={},b={},c=function(b,c){a[b]=c},d=function(a,c){b[a]=c.trim()},e=function(a,b,c){var e=Math.ceil(500*Math.random());switch(a7.Model.get("renderer")){case"mustache":fetch(a+"?"+e).then(function(a){return a.text()}).then(function(a){a7.Log.info("Loading Mustache templates... ");var c=new DOMParser,e=c.parseFromString(a,"text/html"),f=e.querySelectorAll("script");f.forEach(function(a){d(a.getAttribute("id"),a.innerHTML)}),b()});break;case"handlebars":b()}},f=function(a,c){switch(a7.Model.get("renderer")){case"mustache":return Mustache.to_html(b[a],c,b)}};return{render:f,selectors:a,setSelector:c,init:function(a,b,c){var d="handlebars,mustache";a7.Log.info("Layout initializing..."),d.indexOf(a7.Model.get("renderer"))>=0?(a7.Model.set("templatesLoaded",!1),void 0!==a.templates&&e(a.templates,b,c)):b()}}}(),a7.Log=function(){var a="ERROR,FATAL,INFO",b=function(b,c){(a.indexOf(c)>=0||a.indexOf("ALL")>=0)&&(console.log(b),a7.Model.get("console.enabled")&&a7.Console.addMessage(b,new Date,"local",c))};return{init:function(b){a=void 0!==b.logLevel?b.logLevel:"ERROR,FATAL,INFO",a7.Log.info("Log initializing...")},error:function(a){b(a,"ERROR")},fatal:function(a){b(a,"FATAL")},info:function(a){b(a,"INFO")},trace:function(a){b(a,"TRACE")},warn:function(a){b(a,"WARN")}}}(),a7.Model=gadgetui.model,a7.Objects=function(){"use strict";function a(a,b,d){var e,f;return d===!0&&c.getAll().forEach(function(b){void 0===a.prototype[b]&&(a.prototype[b]=b.func)}),f=Object.create(a.prototype),e=a.apply(f,b),void 0===e&&(e=f),d===!0&&(e.events={},void 0!==a.prototype.events&&a.prototype.events.forEach(function(a){e.events[a]=[]})),e}function b(){return this}var c={on:function(a,b){return void 0===this.events[a]&&(this.events[a]=[]),this.events[a].push(b),this},off:function(a){return this.events[a]=[],this},fireEvent:function(a,b){var c=this;this.events[a].forEach(function(a){a(c,b)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};return b.prototype.getMemento=function(){var a={},b=this;return Object.keys(this).forEach(function(c){a[c]=b[c]}),a},{Constructor:a,EventBindings:c,User:b}}(),a7.Remote=function(){var a={};a.hasOwnProperty;return{setModule:function(b,c){a[b]=c},invoke:function(b,c){var d=b.split(".");return d.length<2?void a7.Log.error("No action specified. Valid actions are: "+Object.keys(a[d[0]]).toString()):void("function"==typeof a[d[0]][d[1]]&&a[d[0]][d[1]](c))}}}(),a7.Security=function(){"use strict";var a=function(a,b){if(a7.Log.info("Checking secured state.. "),a7.Model.get("useTokens")){var c=a7.Model.get("token");void 0!==c&&null!==c&&c.length>0?a7.Events.publish("user.refresh",{resolve:a,reject:b}):a(!1)}};return{isSecure:a,init:function(a){a7.Log.info("Security initializing...");var b,c=a7.Objects.Constructor(a7.Objects.User,[],!0);sessionStorage.user&&""!==sessionStorage.user&&(b=JSON.parse(sessionStorage.user),Object.keys(b).map(function(a){c[a]=b[a]})),a7.Model.set("user",c),a7.Model.get("useTokens")&&sessionStorage.token&&""!==sessionStorage.token&&a7.Model.set("token",sessionStorage.token)}}}();
//# sourceMappingURL=a7.min.js.map