var a7=function(){"use strict";return{init:function(a,b,c){var d,e,f,g;a.model=void 0!==a.model?a.model:"object"==typeof gadgetui?"gadgetui":"",""===a.model&&c("No model specified."),d=new Promise(function(b,c){a7.log.trace("a7 - model init"),a7.model.init(a,b,c)}),d.then(function(){a7.model.set("a7",{auth:{sessionTimeout:a.auth.sessionTimeout||9e5},console:{enabled:a.console.enabled||!1,wsServer:a.console.wsServer||"",top:a.console.top||0,right:a.console.right||0},logging:{logLevel:a.logging.logLevel||"ERROR,FATAL,INFO"},model:a.model,remote:{loginURL:a.remote.loginURL||"",refreshURL:a.remote.refreshURL||"",useTokens:a.auth.useTokens||!0},ui:{renderer:"object"==typeof Mustache?"Mustache":"object"==typeof Handlebars?"Handlebars":"",templates:a.ui.templates||void 0},ready:!1,user:""})}).then(function(){e=new Promise(function(a,b){a7.model.get("a7.console.enabled")?(a7.log.trace("a7 - console init"),a7.console.init(a,b)):a()}),e.then(function(){a7.log.trace("a7 - log init"),a7.log.init()}).then(function(){a7.log.trace("a7 - security init"),a7.security.init()}).then(function(){a7.log.trace("a7 - remote init"),a7.remote.init(a.remote.modules)}).then(function(){a7.log.trace("a7 - events init"),a7.events.init()}).then(function(){f=new Promise(function(a,b){a7.log.trace("a7 - layout init"),a7.ui.init(a,b)}),f.then(function(){g=new Promise(function(a,b){a7.log.trace("a7 - isSecured"),a7.security.isAuthenticated(a,b)}),g.then(function(a){a7.log.info("Authenticated: "+a+"..."),a7.log.info("Init complete..."),b({secure:a})}),g.catch(function(a){a7.log.error(a),c()})})}),e.catch(function(a){a7.log.error(a),c()})}),d.catch(function(a){a7.log.error(a),c()})}}}();a7.console=function(){"use strict";var a,b="Console Window",c="50%",d=!1,e=function(b,c,d,e){var f=document.createElement("div");f.setAttribute("class","a7-console-row-"+d),void 0!==e&&(f.innerHTML=e+": ",f.setAttribute("class",f.getAttribute("class")+" a7-console-row-"+e)),f.innerHTML+=+(c.getHours()<10?"0"+c.getHours():c.getHours())+":"+(c.getMinutes()<10?"0"+c.getMinutes():c.getMinutes())+": "+b,a.appendChild(f)};return{init:function(f,g){var h=a7.model.get("a7.console");if(h.enabled){d=!0,a=document.createElement("div"),a.setAttribute("id","consoleDiv"),a.setAttribute("class","a7-console"),document.body.append(a);var i,j=a7.components.Constructor(gadgetui.display.FloatingPane,[a,{width:c,title:b,opacity:.7,position:"absolute",right:h.right,top:h.top}],!1);if(j.selector.setAttribute("right",0),window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void a.innerHTML("Your browser doesn't support WebSockets.");i=new WebSocket(h.wsServer),i.onopen=function(){},i.onerror=function(a){var b="Can't connect to the console socket server.";h.enabled?e(b,new Date,"local"):a7.log.error(b)},i.onmessage=function(a){var b,c;try{b=JSON.parse(a.data)}catch(b){return void a7.log.error("This doesn't look like valid JSON: ",a.data)}if("history"===b.type)for(c=0;c<b.data.length;c++)e(b.data[c].text,new Date(b.data[c].time),"websocket");else"message"===b.type?e(b.data.text,new Date(b.data.time),"websocket"):a7.log.error("This doesn't look like valid JSON: ",b)},window.addEventListener("close",function(a){i.close()}),a7.console.addMessage=e,a7.log.info("Console initializing..."),f()}else g("Console init should not be called when console option is set to false.")}}}(),a7.error=function(){"use strict";var a=function(a,b,c,d,e){var f=a.toLowerCase(),g="script error";if(f.indexOf(g)>-1)a7.log.error("Script Error: See Browser Console for Detail");else{var h=["Message: "+a,"URL: "+b,"Line: "+c,"Column: "+d,"Error object: "+JSON.stringify(e)].join(" - ");a7.log.error(h)}};return window.onerror=function(a,b,c,d,e){return a7.error.captureError(a,b,c,d,e),!1},{capture:function(a){},captureError:a}}(),a7.events=function(){"use strict";var a={},b=a.hasOwnProperty;return{subscribe:function(c,d){b.call(a,c)||(a[c]=[]);var e=a[c].push(d)-1;return{remove:function(){delete a[c][e]}}},init:function(){a7.events.subscribe("auth.login",function(a){a7.remote.invoke("auth.login",a)}),a7.events.subscribe("auth.refresh",function(a){a7.remote.invoke("auth.refresh",a)}),a7.events.subscribe("auth.sessionTimeout",function(a){}),a7.events.subscribe("auth.invalidateSession",function(a){})},publish:function(c,d){a7.log.trace("event: "+c),b.call(a,c)&&a[c].forEach(function(a){a(d||{})})}}}(),a7.log=function(){var a=!1,b=[],c="ERROR,FATAL,INFO",d=function(d,e){a&&c.indexOf(e)>=0||c.indexOf("ALL")>=0?(console.log(d),a7.model.get("a7.console.enabled")&&a7.console.addMessage(d,new Date,"local",e)):a||b.push({message:d,level:e})};return{init:function(){c=a7.model.get("a7.logging").logLevel,a=!0,b.forEach(function(a){d(a.message,a.level)}),_deffered=[],a7.log.info("Log initializing...")},error:function(a){d(a,"ERROR")},fatal:function(a){d(a,"FATAL")},info:function(a){d(a,"INFO")},trace:function(a){d(a,"TRACE")},warn:function(a){d(a,"WARN")}}}(),a7.model=function(){"use strict";var a,b={};return{create:function(){return b.create.apply(a,arguments)},destroy:function(){return b.destroy.apply(a,arguments)},get:function(){return b.get.apply(a,arguments)},set:function(){return b.set.apply(a,arguments)},exists:function(){return b.exists.apply(a,arguments)},bind:function(){return b.bind.apply(a,arguments)},init:function(c,d,e){switch(a7.log.info("Model initializing... "),c.model){case"gadgetui":a=gadgetui.model,Object.keys(gadgetui.model).forEach(function(a,c){"BindableObject"!==a&&(b[a]=gadgetui.model[a])})}d()}}}(),a7.components=function(){"use strict";function a(a,b,d){var e,f;return d===!0&&c.getAll().forEach(function(b){void 0===a.prototype[b]&&(a.prototype[b]=b.func)}),f=Object.create(a.prototype),e=a.apply(f,b),void 0===e&&(e=f),d===!0&&(e.events={},void 0!==a.prototype.events&&a.prototype.events.forEach(function(a){e.events[a]=[]})),e}function b(){return this}var c={on:function(a,b){return void 0===this.events[a]&&(this.events[a]=[]),this.events[a].push(b),this},off:function(a){return this.events[a]=[],this},fireEvent:function(a,b){var c=this;this.events[a].forEach(function(a){a(c,b)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};return b.prototype.getMemento=function(){var a={},b=this;return Object.keys(this).forEach(function(c){a[c]=b[c]}),a},{Constructor:a,EventBindings:c,User:b}}(),a7.remote=function(){var a,b,c={},d=new Date,e={},f=(e.hasOwnProperty,function(a,b){e[a]=b});return{getToken:function(){return a},getSessionTimer:function(){return b},init:function(b){c=a7.model.get("a7.remote"),c.sessionTimeout=a7.model.get("a7.auth").sessionTimeout,c.useTokens&&sessionStorage.token&&""!==sessionStorage.token&&(a=sessionStorage.token);var d={login:function(b,d,e){var f,g={method:"POST",headers:{Authorization:"Basic "+a7.util.base64.encode64(b+":"+d)}};f=new Request(c.loginURL,g);var h=fetch(f);h.then(function(b){var c=b.headers.get("X-Token");return void 0!==c&&null!==c&&(a=c,sessionStorage.token=c),b.json()}).then(function(a){var b=a7.model.get("a7.user");Object.keys(a.user).map(function(c){b[c]=a.user[c]}),sessionStorage.user=JSON.stringify(b),a7.model.set("a7.user",b),void 0!==e&&e(a)})},refresh:function(a,b){a7.remote.fetch(c.refreshURL,{},!0).then(function(a){return a.json()}).then(function(b){void 0!==a&&a(b.success)})}};f("auth",d),Object.keys(b).forEach(function(a){f(a,b[a])})},fetch:function(e,f,g){a7.log.info("fetch: "+e);var h,i;if(g&&c.useTokens){var j=new Date,k=Math.abs(j-d),l=Math.floor(k/1e3/60);if(l>c.sessionTimeout)return void a7.events.publish("auth.sessionTimeout");void 0!==a&&null!==a&&(void 0===f.headers?f.headers={"X-Token":a}:f.headers["X-Token"]=a),d=j}return h=new Request(e,f),i=fetch(h),i.then(function(d){if(g&&c.useTokens){var e=d.headers.get("X-Token");void 0!==e&&null!==e?(a=e,sessionStorage.token=e,void 0!==b&&clearTimeout(b),b=setTimeout(function(){a7.remote.invoke("auth.refresh")},c.sessionTimeout)):a7.events.publish("auth.sessionTimeout")}}),i},invoke:function(a,b){var c=a.split(".");return c.length<2?void a7.log.error("No action specified. Valid actions are: "+Object.keys(e[c[0]]).toString()):void("function"==typeof e[c[0]][c[1]]&&e[c[0]][c[1]].apply(e[c[0]][c[1]],b))}}}(),a7.security=function(){"use strict";var a=function(a,b){if(a7.log.info("Checking authenticated state.. "),a7.model.get("a7.remote.useTokens")){var c=a7.remote.getToken();if(void 0!==c&&null!==c&&c.length>0){var d=a7.remote.getSessionTimer();void 0===d?(a7.log.info("Refreshing user..."),a7.events.publish("auth.refresh",[a,b])):a(!0)}else a(!1)}};return{isAuthenticated:a,init:function(){a7.log.info("Security initializing...");var a,b=a7.components.Constructor(a7.components.User,[],!0);sessionStorage.user&&""!==sessionStorage.user&&(a=JSON.parse(sessionStorage.user),Object.keys(a).map(function(c){b[c]=a[c]})),a7.model.set("a7.user",b)}}}(),a7.ui=function(){"use strict";var a={},b={},c={},d=function(a,c){b[a]=c},e=function(b,d){switch(a.renderer){case"Mustache":c[b]=d.trim();break;case"Handlebars":c[b]=Handlebars.compile(d.trim())}},f=function(b,c){var d=Math.ceil(500*Math.random());switch(a.renderer){case"Mustache":case"Handlebars":fetch(a.templates+"?"+d).then(function(a){return a.text()}).then(function(c){a7.log.info("Loading "+a.renderer+" templates... ");var d=new DOMParser,f=d.parseFromString(c,"text/html"),g=f.querySelectorAll("script");g.forEach(function(a){e(a.getAttribute("id"),a.innerHTML)}),b()})}},g=function(b,d,e){switch(a.renderer){case"Mustache":return Mustache.render(c[b],d,e);case"Handlebars":return c[b](d)}};return{render:g,selectors:b,setSelector:d,getTemplate:function(a){return c[a]},init:function(b,c){var d="Handlebars,Mustache";a=a7.model.get("a7.ui"),a7.log.info("Layout initializing..."),d.indexOf(a.renderer)>=0?(a7.model.set("a7.ui.templatesLoaded",!1),void 0!==a.templates&&f(b,c)):b()}}}(),a7.util=function(){return{split:function(a){return a.split(/,\s*/)},extractLast:function(a){return this.split(a).pop()},base64:{keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64:function(a){if(!String(a).length)return!1;var b,c,d,e,f,g,h,i="",j=0;do b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this.keyStr.charAt(e)+this.keyStr.charAt(f)+this.keyStr.charAt(g)+this.keyStr.charAt(h);while(j<a.length);return i},decode64:function(a){if(!a)return!1;var b,c,d,e,f,g,h,i="",j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=this.keyStr.indexOf(a.charAt(j++)),f=this.keyStr.indexOf(a.charAt(j++)),g=this.keyStr.indexOf(a.charAt(j++)),h=this.keyStr.indexOf(a.charAt(j++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,i+=String.fromCharCode(b),64!==g&&(i+=String.fromCharCode(c)),64!==h&&(i+=String.fromCharCode(d));while(j<a.length);return i}},leadingZero:function(a){return a<10?"0"+a:a},dynamicSort:function(a){var b=1;return"-"===a[0]&&(b=-1,a=a.substr(1)),function(c,d){var e=c[a]<d[a]?-1:c[a]>d[a]?1:0;return e*b}},yesNo:function(a){return parseInt(a,10)<1?"No":"Yes"},isValidDate:function(a){return"[object Date]"===Object.prototype.toString.call(a)&&!isNaN(a.getTime())},id:function(){return((100*Math.random()).toString()+(100*Math.random()).toString()).replace(/\./g,"")},tryCatch:function(a,b,c){var d={value:null};try{return a.apply(b,c)}catch(a){return d.value=a,d}},getNumberValue:function(a){return isNaN(Number(a))?Number(a.substring(0,a.length-2)):a},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},getOffset:function(a){var b=a.getBoundingClientRect();return{top:b.top+document.body.scrollTop,left:b.left+document.body.scrollLeft}}}}();
//# sourceMappingURL=a7.min.js.map