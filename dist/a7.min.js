var a7=function(){"use strict";return{init:function(n,t,o){var e,r,i;n.model=void 0!==n.model?n.model:"object"==typeof gadgetui?"gadgetui":"",""===n.model&&o("No model specified."),(e=new Promise(function(e,t){a7.log.trace("a7 - model init"),a7.model.init(n,e,t)})).then(function(){a7.model.set("a7",{auth:{sessionTimeout:n.auth.sessionTimeout||9e5},console:{enabled:n.console.enabled||!1,wsServer:n.console.wsServer||"",top:n.console.top||100,left:n.console.left||100,width:n.console.width||500,height:n.console.height||300},logging:{logLevel:n.logging.logLevel||"ERROR,FATAL,INFO"},model:n.model,remote:{loginURL:n.remote.loginURL||"",refreshURL:n.remote.refreshURL||"",useTokens:n.auth.useTokens||!0},ui:{renderer:"object"==typeof Mustache?"Mustache":"object"==typeof Handlebars?"Handlebars":"",templates:n.ui.templates||void 0},ready:!1,user:""})}).then(function(){(r=new Promise(function(e,t){a7.model.get("a7.console").enabled?(a7.log.trace("a7 - console init"),a7.console.init(e,t)):e()})).then(function(){a7.log.trace("a7 - log init"),a7.log.init(),a7.log.trace("a7 - security init"),a7.security.init(),a7.log.trace("a7 - remote init"),a7.remote.init(n.remote.modules),a7.log.trace("a7 - events init"),a7.events.init(),new Promise(function(e,t){a7.log.trace("a7 - layout init"),a7.ui.init(e,t)}).then(function(){(i=new Promise(function(e,t){a7.log.trace("a7 - isSecured"),a7.security.isAuthenticated(e,t)})).then(function(e){a7.log.info("Authenticated: "+e+"..."),a7.log.info("Init complete..."),t({secure:e})}),i.catch(function(e){a7.log.error(e),o()})})}),r.catch(function(e){a7.log.error(e),o()})}),e.catch(function(e){a7.log.error(e),o()})}}}();a7.console=function(){"use strict";var i,r=function(e,t,n,o){var r=document.createElement("div");r.setAttribute("class","a7-console-row-"+n),void 0!==o&&(r.innerHTML=o+": ",r.setAttribute("class",r.getAttribute("class")+" a7-console-row-"+o)),r.innerHTML+=+(t.getHours()<10?"0"+t.getHours():t.getHours())+":"+(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+": "+e,i.appendChild(r)};return{init:function(e,t){var n=a7.model.get("a7.console");if(n.enabled){var o;if(!0,(i=document.createElement("div")).setAttribute("id","consoleDiv"),i.setAttribute("class","a7-console"),document.body.append(i),a7.components.Constructor(gadgetui.display.FloatingPane,[i,{width:n.width,left:n.left,height:n.height,title:"Console Window",top:n.top,enableShrink:!1,enableClose:!0}],!1).selector.setAttribute("right",0),window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void i.innerHTML("Your browser doesn't support WebSockets.");(o=new WebSocket(n.wsServer)).onopen=function(){},o.onerror=function(){var e="Can't connect to the console socket server.";n.enabled?r(e,new Date,"local"):a7.log.error(e)},o.onmessage=function(t){var e,n;try{e=JSON.parse(t.data)}catch(e){return void a7.log.error("This doesn't look like valid JSON: ",t.data)}if("history"===e.type)for(n=0;n<e.data.length;n++)r(e.data[n].text,new Date(e.data[n].time),"websocket");else"message"===e.type?r(e.data.text,new Date(e.data.time),"websocket"):a7.log.error("This doesn't look like valid JSON: ",e)},window.addEventListener("close",function(){o.close()}),a7.console.addMessage=r,a7.log.info("Console initializing..."),e()}else t("Console init should not be called when console option is set to false.")}}}(),a7.error=function(){"use strict";return window.onerror=function(e,t,n,o,r){return a7.error.captureError(e,t,n,o,r),!1},{capture:function(){},captureError:function(e,t,n,o,r){if(-1<e.toLowerCase().indexOf("script error"))a7.log.error("Script Error: See Browser Console for Detail");else{var i=["Message: "+e,"URL: "+t,"Line: "+n,"Column: "+o,"Error object: "+JSON.stringify(r)].join(" - ");a7.log.error(i)}}}}(),a7.events=function(){"use strict";var o={},r=o.hasOwnProperty;return{subscribe:function(e,t){r.call(o,e)||(o[e]=[]);var n=o[e].push(t)-1;return{remove:function(){delete o[e][n]}}},init:function(){a7.events.subscribe("auth.login",function(e){a7.remote.invoke("auth.login",e)}),a7.events.subscribe("auth.refresh",function(e){a7.remote.invoke("auth.refresh",e)}),a7.events.subscribe("auth.sessionTimeout",function(){}),a7.events.subscribe("auth.invalidateSession",function(){})},publish:function(e,t){a7.log.trace("event: "+e),r.call(o,e)&&o[e].forEach(function(e){e(t||{})})}}}(),a7.log=function(){var n=!1,o=[],r="ERROR,FATAL,INFO",t=function(e,t){n&&0<=r.indexOf(t)||0<=r.indexOf("ALL")?a7.model.get("a7.console").enabled&&a7.console.addMessage(e,new Date,"local",t):n||o.push({message:e,level:t})};return{init:function(){r=a7.model.get("a7.logging").logLevel,n=!0,o.forEach(function(e){t(e.message,e.level)}),_deffered=[],a7.log.info("Log initializing...")},error:function(e){t(e,"ERROR")},fatal:function(e){t(e,"FATAL")},info:function(e){t(e,"INFO")},trace:function(e){t(e,"TRACE")},warn:function(e){t(e,"WARN")}}}(),a7.model=function(){"use strict";var n,o={};return{create:function(){return o.create.apply(n,arguments)},destroy:function(){return o.destroy.apply(n,arguments)},get:function(){return o.get.apply(n,arguments)},set:function(){return o.set.apply(n,arguments)},exists:function(){return o.exists.apply(n,arguments)},bind:function(){return o.bind.apply(n,arguments)},init:function(e,t){switch(a7.log.info("Model initializing... "),e.model){case"gadgetui":n=gadgetui.model,Object.keys(gadgetui.model).forEach(function(e){"BindableObject"!==e&&(o[e]=gadgetui.model[e])})}t()}}}(),a7.components=function(){"use strict";var i={on:function(e,t){return void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t),this},off:function(e){return this.events[e]=[],this},fireEvent:function(e,t){var n=this;this.events[e].forEach(function(e){e(n,t)})},getAll:function(){return[{name:"on",func:this.on},{name:"off",func:this.off},{name:"fireEvent",func:this.fireEvent}]}};function e(){return this}return e.prototype.getMemento=function(){var t={},n=this;return Object.keys(this).forEach(function(e){t[e]=n[e]}),t},{Constructor:function(t,e,n){var o,r;return!0===n&&i.getAll().forEach(function(e){void 0===t.prototype[e]&&(t.prototype[e]=e.func)}),r=Object.create(t.prototype),void 0===(o=t.apply(r,e))&&(o=r),!0===n&&(o.events={},void 0!==t.prototype.events&&t.prototype.events.forEach(function(e){o.events[e]=[]})),o},EventBindings:i,User:e}}(),a7.remote=function(){var s,u,c={},l=new Date,o={},n=function(e,t){o[e]=t};return{getToken:function(){return s},getSessionTimer:function(){return u},init:function(t){(c=a7.model.get("a7.remote")).sessionTimeout=a7.model.get("a7.auth").sessionTimeout,c.useTokens&&sessionStorage.token&&""!==sessionStorage.token&&(s=sessionStorage.token),n("auth",{login:function(e,t,o){var n,r={method:"POST",headers:{Authorization:"Basic "+a7.util.base64.encode64(e+":"+t)}};n=new Request(c.loginURL,r),fetch(n).then(function(e){var t=e.headers.get("X-Token");return null!=t&&(s=t,sessionStorage.token=t),e.json()}).then(function(t){var n=a7.model.get("a7.user");Object.keys(t.user).map(function(e){n[e]=t.user[e]}),sessionStorage.user=JSON.stringify(n),a7.model.set("a7.user",n),void 0!==o&&o(t)})},refresh:function(t){a7.remote.fetch(c.refreshURL,{},!0).then(function(e){return e.json()}).then(function(e){void 0!==t&&t(e.success)})}}),Object.keys(t).forEach(function(e){n(e,t[e])})},fetch:function(e,t,n){var o,r;if(a7.log.info("fetch: "+e),n&&c.useTokens){var i=new Date,a=Math.abs(i-l);if(Math.floor(a/1e3/60)>c.sessionTimeout)return void a7.events.publish("auth.sessionTimeout");null!=s&&(void 0===t.headers?t.headers={"X-Token":s}:t.headers["X-Token"]=s),l=i}return o=new Request(e,t),(r=fetch(o)).then(function(e){if(n&&c.useTokens){var t=e.headers.get("X-Token");null!=t?(s=t,sessionStorage.token=t,void 0!==u&&clearTimeout(u),u=setTimeout(function(){a7.remote.invoke("auth.refresh")},c.sessionTimeout)):a7.events.publish("auth.sessionTimeout")}}),r},invoke:function(e,t){var n=e.split(".");n.length<2?a7.log.error("No action specified. Valid actions are: "+Object.keys(o[n[0]]).toString()):"function"==typeof o[n[0]][n[1]]&&o[n[0]][n[1]].apply(o[n[0]][n[1]],t)}}}(),a7.security=function(){"use strict";return{isAuthenticated:function(e,t){if(a7.log.info("Checking authenticated state.. "),a7.model.get("a7.remote.useTokens")){var n=a7.remote.getToken();null!=n&&0<n.length?void 0===a7.remote.getSessionTimer()?(a7.log.info("Refreshing user..."),a7.events.publish("auth.refresh",[e,t])):e(!0):e(!1)}},init:function(){a7.log.info("Security initializing...");var t,n=a7.components.Constructor(a7.components.User,[],!0);sessionStorage.user&&""!==sessionStorage.user&&(t=JSON.parse(sessionStorage.user),Object.keys(t).map(function(e){n[e]=t[e]})),a7.model.set("a7.user",n)}}}(),a7.ui=function(){"use strict";var o={},n={},r={},i=[],a=function(t){var e=Math.ceil(500*Math.random());switch(o.renderer){case"Mustache":case"Handlebars":fetch(o.templates+"?"+e).then(function(e){return e.text()}).then(function(e){a7.log.info("Loading "+o.renderer+" templates... "),(new DOMParser).parseFromString(e,"text/html").querySelectorAll("script").forEach(function(e){!function(e,t){switch(o.renderer){case"Mustache":r[e]=t.trim();break;case"Handlebars":r[e]=Handlebars.compile(t.trim())}}(e.getAttribute("id"),e.innerHTML)}),t()})}};return{render:function(e,t,n){switch(o.renderer){case"Mustache":return Mustache.render(r[e],t,n);case"Handlebars":return r[e](t)}},selectors:n,getSelector:function(e){return n[e]},setSelector:function(e,t){n[e]=t},setView:function(e,t){i[e]=t},getView:function(e){return i[e]},removeView:function(e){delete i[e]},getTemplate:function(e){return r[e]},init:function(e,t){o=a7.model.get("a7.ui"),a7.log.info("Layout initializing..."),0<="Handlebars,Mustache".indexOf(o.renderer)?(a7.model.set("a7.ui.templatesLoaded",!1),void 0!==o.templates&&a(e)):e()}}}(),a7.util={split:function(e){return e.split(/,\s*/)},extractLast:function(e){return this.split(e).pop()},base64:{keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64:function(e){if(!String(e).length)return!1;for(var t,n,o,r,i,a,s,u="",c=0;r=(t=e.charCodeAt(c++))>>2,i=(3&t)<<4|(n=e.charCodeAt(c++))>>4,a=(15&n)<<2|(o=e.charCodeAt(c++))>>6,s=63&o,isNaN(n)?a=s=64:isNaN(o)&&(s=64),u=u+this.keyStr.charAt(r)+this.keyStr.charAt(i)+this.keyStr.charAt(a)+this.keyStr.charAt(s),c<e.length;);return u},decode64:function(e){if(!e)return!1;var t,n,o,r,i,a,s="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");t=this.keyStr.indexOf(e.charAt(u++))<<2|(r=this.keyStr.indexOf(e.charAt(u++)))>>4,n=(15&r)<<4|(i=this.keyStr.indexOf(e.charAt(u++)))>>2,o=(3&i)<<6|(a=this.keyStr.indexOf(e.charAt(u++))),s+=String.fromCharCode(t),64!==i&&(s+=String.fromCharCode(n)),64!==a&&(s+=String.fromCharCode(o)),u<e.length;);return s}},leadingZero:function(e){return e<10?"0"+e:e},dynamicSort:function(n){var o=1;return"-"===n[0]&&(o=-1,n=n.substr(1)),function(e,t){return(e[n]<t[n]?-1:e[n]>t[n]?1:0)*o}},yesNo:function(e){return parseInt(e,10)<1?"No":"Yes"},isValidDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime())},id:function(){return((100*Math.random()).toString()+(100*Math.random()).toString()).replace(/\./g,"")},tryCatch:function(e,t,n){var o={value:null};try{return e.apply(t,n)}catch(e){return o.value=e,o}},getNumberValue:function(e){return isNaN(Number(e))?Number(e.substring(0,e.length-2)):e},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getOffset:function(e){var t=e.getBoundingClientRect();return{top:t.top+document.body.scrollTop,left:t.left+document.body.scrollLeft}}};
//# sourceMappingURL=a7.min.js.map